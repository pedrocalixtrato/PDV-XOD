package dc.visao.suprimento.compra;

import java.util.List;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Component;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.Field;
import com.vaadin.ui.GridLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.TableFieldFactory;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

import dc.controller.suprimento.compra.RequisicaoCompraFormController;
import dc.entidade.geral.pessoal.ColaboradorEntity;
import dc.entidade.geral.produto.ProdutoEntity;
import dc.entidade.suprimentos.compra.RequisicaoCompraDetalheEntity;
import dc.entidade.suprimentos.compra.TipoRequisicaoEntity;
import dc.visao.framework.component.SubFormComponent;
import dc.visao.framework.component.manytoonecombo.ManyToOneComboField;
import dc.visao.framework.util.ComponentUtil;

public class RequisicaoCompraFormView extends CustomComponent {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private GridLayout fields;
	@AutoGenerated
	private Label lblId;
	@AutoGenerated
	private PopupDateField calDataRequisicao;
	//@AutoGenerated
	//private LookupComponent<Integer, ColaboradorEntity> lkpRequisitante;
	@AutoGenerated
	private ManyToOneComboField<TipoRequisicaoEntity> cmbTipoRequisicao;
	
	@AutoGenerated
	private ManyToOneComboField<ColaboradorEntity> cmbColaborador;

	@AutoGenerated
	private TextArea txtObservacao;

	private RequisicaoCompraFormController controller;

	private SubFormComponent<RequisicaoCompraDetalheEntity, Integer> requisicaoDetalheSubForm;

	public RequisicaoCompraFormView(RequisicaoCompraFormController controller) {
		this.controller = controller;
		buildMainLayout();
		setCompositionRoot(mainLayout);
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		setSizeFull();
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setSizeFull();
		mainLayout.setMargin(false);
		mainLayout.setSpacing(true);

		// top-level component properties
		setWidth("100.0%");
		// setHeight("100.0%");

		// fields
		fields = buildFields();
		mainLayout.addComponent(fields);

		// subForm
		mainLayout.addComponent(buildSubForms());
		mainLayout.setExpandRatio(requisicaoDetalheSubForm, 1);

		return mainLayout;
	}

	public PopupDateField getCalDataRequisicao() {
		return calDataRequisicao;
	}

	/*public LookupComponent<Integer, ColaboradorEntity> getLkpRequisitante() {
		return lkpRequisitante;
	}*/

	public ManyToOneComboField<TipoRequisicaoEntity> getCmbTipoRequisicao() {
		return cmbTipoRequisicao;
	}

	public TextArea getTxtObservacao() {
		return txtObservacao;
	}

	public void setTxtObservacao(TextArea txtObservacao) {
		this.txtObservacao = txtObservacao;
	}

	@AutoGenerated
	private GridLayout buildFields() {
		// common part: create layout
		fields = new GridLayout(6, 2);
		fields.setImmediate(false);
		fields.setWidth("100.0%");
		fields.setHeight("-1px");
		fields.setMargin(false);
		fields.setSpacing(true);

		// cmbTipoRequisicao
		cmbTipoRequisicao = new ManyToOneComboField<>(TipoRequisicaoEntity.class);
		cmbTipoRequisicao.setCaption("Tipo de Requisição");
		fields.addComponent(cmbTipoRequisicao, 0, 0, 1,0);

		// lkpRequisitante
		//lkpRequisitante = ComponentUtil.buildLookup("Id", "Requisitante");
		//fields.addComponent(lkpRequisitante, 1, 0, 3, 0);
		cmbColaborador = new ManyToOneComboField<>(ColaboradorEntity.class);
		cmbColaborador.setCaption("Colaborador");
		fields.addComponent(cmbColaborador, 2,0,3,0);

		// calDataRequisicao
		calDataRequisicao = new PopupDateField();
		calDataRequisicao.setCaption("Data Requisição");
		calDataRequisicao.setImmediate(false);
		fields.addComponent(calDataRequisicao, 4, 0);

		txtObservacao = ComponentUtil.buildTextArea("Observação");
		fields.addComponent(txtObservacao, 0, 1, 4,1);

		return fields;
	}

	@AutoGenerated
	@SuppressWarnings("serial")
	private SubFormComponent<?, ?> buildSubForms() {
		requisicaoDetalheSubForm = new SubFormComponent<RequisicaoCompraDetalheEntity, Integer>(
				RequisicaoCompraDetalheEntity.class, new String[] { "produto", "quantidade","itemCotado","quantidadeCotada" },
				new String[] { "Produto", "Quantidade","Item Cotado","Quantidade Cotada" }) {
			@Override
			protected TableFieldFactory getFieldFactory() {
				return new TableFieldFactory() {

					@Override
					public Field<?> createField(Container container,
							Object itemId, Object propertyId,
							Component uiContext) {
						if ("produto".equals(propertyId)) {
							ComboBox comboBox = ComponentUtil
									.buildComboBox(null);
							BeanItemContainer<ProdutoEntity> produtoContainer = new BeanItemContainer<>(
									ProdutoEntity.class,
									controller.buscarProdutos());
							produtoContainer.addNestedContainerProperty("nome");
							comboBox.setContainerDataSource(produtoContainer);
							comboBox.setItemCaptionPropertyId("nome");
							return comboBox;
						} else if ("quantidade".equals(propertyId)) {
							TextField textField = ComponentUtil.buildNumberField(null);
							return textField;
						}else if ("itemCotada".equals(propertyId)) {
							ComboBox cmb = ComponentUtil.buildComboBox(null);
							cmb.addItem("NÃO");
							return cmb;
						}else if ("quantidadeCotada".equals(propertyId)) {
							TextField textField = ComponentUtil.buildNumberField(null);
							return textField;
						}
						return null;
					}
				};
			}

			protected RequisicaoCompraDetalheEntity getNovo() {
				RequisicaoCompraDetalheEntity requisicaoDetalhe = controller
						.novoRequisicaoDetalhe();
				return requisicaoDetalhe;
			}

			protected void getRemoverSelecionados(
					List<RequisicaoCompraDetalheEntity> values) {
				controller.removerRequisicaoDetalhes(values);
			}

			@Override
			public boolean validateItems(List<RequisicaoCompraDetalheEntity> items) {
				for (RequisicaoCompraDetalheEntity requisicaoDetalhe : items) {
					if (requisicaoDetalhe.getProduto() == null
							|| requisicaoDetalhe.getQuantidade() == null) {
						return false;
					}
				}
				return true;
			}
		};

		return requisicaoDetalheSubForm;
	}

	/*public void fillCmbRequisitante(List<ColaboradorEntity> lista) {
		BeanContainer<Integer, ColaboradorEntity> tipoRequisicaoContainer = lkpRequisitante
				.createContainer(ColaboradorEntity.class);
		tipoRequisicaoContainer.addNestedContainerProperty("pessoa.nome");
		tipoRequisicaoContainer.addAll(lista);
		lkpRequisitante.setItemCaptionPropertyId("pessoa.nome");
	}*/
	
	public void fillRequisicaoDetalhesSubForm(
			List<RequisicaoCompraDetalheEntity> requisicaoDetalhes) {
		requisicaoDetalheSubForm.fillWith(requisicaoDetalhes);
	}

	public ManyToOneComboField<ColaboradorEntity> getCmbColaborador() {
		return cmbColaborador;
	}

	public void setCmbColaborador(
			ManyToOneComboField<ColaboradorEntity> cmbColaborador) {
		this.cmbColaborador = cmbColaborador;
	}

	public Label getLblId() {
		return lblId;
	}

}